# Efficiency24 ROI Calculator (Cloudflare Worker Version)

Web-based ROI calculator for Argentine SMEs considering Bitrix24 CRM + chatbot, deployed as a Cloudflare Worker. The Worker serves the static React frontend (built with Vite) and provides a secure backend API endpoint for interacting with the Google Gemini API.

## Prerequisites

*   Bun installed (as `bun install` and `bun run` are used).
*   Node.js and npm/pnpm/yarn might be needed for `npx wrangler` if not using `bunx wrangler`.
*   A Cloudflare account.
*   Wrangler CLI installed (`npm install -g wrangler` or `bun add --dev wrangler` or use `bunx wrangler`).

## Project Structure

*   `public/`: Contains the client-side React application source files (`index.html`, `index.tsx`, `App.tsx`, components, etc.). Vite uses this as its root.
*   `worker/`: Contains the Cloudflare Worker script source (`worker.ts`).
*   `dist/`: Contains the built output:
    *   Static frontend assets (from Vite build, e.g., `index.html`, CSS, JS bundles).
    *   Compiled worker script (`_worker.js`).
    This directory is generated by the `bun run build` command.
*   `vite.config.ts`: Configuration for Vite.
*   `wrangler.toml`: Configuration for the Cloudflare Worker.
*   `package.json`: Project dependencies and scripts.
*   `tsconfig.json`: TypeScript configuration.

## Setup

1.  **Clone/Download Files:**
    Ensure you have all the project files.

2.  **Install Dependencies:**
    ```bash
    bun install
    ```

3.  **Configure `wrangler.toml`:**
    *   Open `wrangler.toml`.
    *   Your Cloudflare `account_id` should be configured (either in the file, globally via Wrangler login, or as an environment variable `CLOUDFLARE_ACCOUNT_ID`).
    *   The `name` of the worker can be customized.
    *   `main` is set to `dist/_worker.js`, pointing to the worker script compiled by `bun run build:worker`.
    *   `[site].bucket` is set to `./dist`, where Vite outputs the static frontend assets.
    *   `[build].command` is set to `"bun install && bun run build"`. This command is executed by Cloudflare (e.g., when deploying via Git integration) or by `wrangler deploy` to build your project.

4.  **API Key Management:**
    The Google Gemini API key is handled securely by the Cloudflare Worker.
    *   **For Production Deployment:** Set the `API_KEY` as a secret in your Worker's settings via the Cloudflare dashboard or Wrangler CLI:
        ```bash
        npx wrangler secret put API_KEY
        # or using bunx:
        # bunx wrangler secret put API_KEY
        ```
        You will be prompted to enter your API key.
    *   **For Local Development (`wrangler dev`):** Create a `.dev.vars` file in the project root:
        ```
        API_KEY="YOUR_GEMINI_API_KEY_FOR_LOCAL_DEV"
        ```
        **Important:** Add `.dev.vars` to your `.gitignore` file to prevent committing your API key.

## Available Scripts (in `package.json`)

*   **`bun run build:client`**: Compiles the client-side React application using Vite (from `public/` to `dist/`).
*   **`bun run build:worker`**: Compiles the Worker script (`worker/worker.ts` to `dist/_worker.js`) using esbuild.
*   **`bun run build`**: Runs both `build:client` and `build:worker` to prepare all assets in the `dist/` directory. This is the command used by Cloudflare's build system via `wrangler.toml`.
*   **`bun run dev`**: Starts the local development server using `wrangler dev`. This will typically execute the `[build].command` (i.e., `bun install && bun run build`) as defined in `wrangler.toml` and watch for changes.
*   **`bun run deploy`**: Builds the project (using the `[build].command` from `wrangler.toml`) and deploys the Worker and static assets from the `dist/` directory to Cloudflare.

## Local Development

1.  Ensure you have a `.dev.vars` file with your `API_KEY` as described above.
2.  Run:
    ```bash
    bun run dev
    ```
    Wrangler will start a local server (typically `http://localhost:8787`), build your project, and serve your application.

## Deployment to Cloudflare

1.  Ensure `wrangler.toml` is correctly configured and you have set the `API_KEY` secret in your Cloudflare Worker settings.
2.  Run:
    ```bash
    bun run deploy
    ```
    Wrangler will execute the `[build].command` from `wrangler.toml` (which is `bun install && bun run build`) and then deploy your Worker script (`dist/_worker.js`) and the static assets from the `dist/` directory to Cloudflare.

## How It Works

*   **Client-Side Application (Source: `public/`, Build Output: `dist/`):**
    *   A React application built with TypeScript/TSX and Vite.
    *   User inputs data into the ROI calculator form.
    *   On submit, the app sends data via a `fetch` POST request to `/api/prepare-email`.
*   **Cloudflare Worker (Source: `worker/worker.ts`, Build Output: `dist/_worker.js`):**
    *   **API Endpoint (`/api/prepare-email`):**
        *   Receives data from the client.
        *   Uses the `API_KEY` (from Worker secrets) to call the Google Gemini API.
        *   Returns a response to the client.
    *   **Static Asset Serving:**
        *   For all other requests, it uses `@cloudflare/kv-asset-handler` (implicitly configured by Wrangler for sites) to serve static files from the `dist/` directory.
*   **Build Process (`bun run build`):**
    *   `bun run build:client` (Vite) compiles `public/index.tsx` and related files into `dist/`.
    *   `bun run build:worker` (esbuild) compiles `worker/worker.ts` into `dist/_worker.js`.
    *   All output is placed in the `dist/` directory, ready for Wrangler to deploy.
